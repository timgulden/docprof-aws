<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Direct PDF.js Test</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    #status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    canvas {
      border: 1px solid #ccc;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Direct PDF.js Test</h1>
  <div id="status" class="info">Initializing...</div>
  <div>
    <label>Book ID: <input type="text" id="bookId" value="76c478d7-a828-47a7-8eb6-2e14d1a43cce" style="width: 400px;"></label>
    <button id="loadBtn">Load PDF</button>
  </div>
  <div id="canvasContainer"></div>
  <div id="log"></div>

  <!-- PDF.js from CDN -->
  <script src="https://unpkg.com/pdfjs-dist@5.4.296/build/pdf.min.mjs" type="module"></script>

  <script type="module">
    const { pdfjsLib } = window;
    
    // Configure worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@5.4.296/build/pdf.worker.min.mjs`;
    
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const canvasContainer = document.getElementById('canvasContainer');
    const bookIdInput = document.getElementById('bookId');
    const loadBtn = document.getElementById('loadBtn');
    
    function log(message, type = 'info') {
      const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(p);
      console.log(message);
    }
    
    function setStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = type;
    }
    
    async function fetchPDF(bookId) {
      log(`Fetching PDF for bookId: ${bookId}`);
      
      try {
        const response = await fetch(`http://localhost:8000/api/books/${bookId}/pdf`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        log(`PDF fetched: ${blob.size} bytes, type: ${blob.type}`);
        
        if (blob.type !== 'application/pdf') {
          log(`Warning: MIME type is ${blob.type}, correcting to application/pdf`);
          return new Blob([blob], { type: 'application/pdf' });
        }
        
        return blob;
      } catch (error) {
        log(`Error fetching PDF: ${error.message}`, 'error');
        throw error;
      }
    }
    
    async function loadPDF(bookId) {
      try {
        setStatus('Loading...', 'info');
        canvasContainer.innerHTML = '';
        logDiv.innerHTML = '';
        
        log('Step 1: Fetching PDF from API');
        const blob = await fetchPDF(bookId);
        
        log('Step 2: Creating blob URL');
        const blobUrl = URL.createObjectURL(blob);
        log(`Blob URL created: ${blobUrl}`);
        
        log('Step 3: Loading PDF document with PDF.js');
        log(`Worker URL: ${pdfjsLib.GlobalWorkerOptions.workerSrc}`);
        
        const loadingTask = pdfjsLib.getDocument({
          url: blobUrl,
          // Try with blob directly too
          // data: await blob.arrayBuffer(),
        });
        
        log('Step 4: Waiting for document promise...');
        const pdf = await loadingTask.promise;
        
        log(`✅ Document loaded! Pages: ${pdf.numPages}`);
        setStatus(`✅ Success! PDF loaded with ${pdf.numPages} pages.`, 'success');
        
        log('Step 5: Rendering first page');
        const page = await pdf.getPage(1);
        log(`Page 1 loaded, page number: ${page.pageNumber}`);
        
        const viewport = page.getViewport({ scale: 1.5 });
        log(`Viewport: ${viewport.width}x${viewport.height}`);
        
        if (!viewport || !viewport.width || !viewport.height) {
          throw new Error(`Invalid viewport: ${JSON.stringify(viewport)}`);
        }
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvasContainer.appendChild(canvas);
        
        log('Step 6: Rendering page to canvas');
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        await page.render(renderContext).promise;
        
        log('✅ Page rendered successfully!');
        setStatus(`✅ Success! Rendered page 1 of ${pdf.numPages}.`, 'success');
        
        // Clean up blob URL
        URL.revokeObjectURL(blobUrl);
        
      } catch (error) {
        log(`❌ Error: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
        setStatus(`❌ Error: ${error.message}`, 'error');
        console.error('Full error:', error);
      }
    }
    
    loadBtn.addEventListener('click', () => {
      const bookId = bookIdInput.value.trim();
      if (bookId) {
        loadPDF(bookId);
      }
    });
    
    // Auto-load on page load
    window.addEventListener('load', () => {
      log('Page loaded, ready to test');
      setStatus('Ready. Click "Load PDF" to test.', 'info');
    });
  </script>
</body>
</html>
