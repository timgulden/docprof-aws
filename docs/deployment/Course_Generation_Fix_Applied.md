# Course Generation Fix Applied

## Summary

Fixed the course generation handler to properly convert command results to events, enabling the complete pipeline to execute.

## Changes Made

### 1. Added Missing Event Imports

**File:** `src/lambda/course_generator/handler.py`

Added imports for all course events:
- `PartsGeneratedEvent` - Phase 1 completion
- `PartSectionsGeneratedEvent` - Phase 2-N completion
- `AllPartsCompleteEvent` - All parts done (handled by logic)
- `OutlineReviewEvent` - Phase N+1 completion
- `CourseStoredEvent` - Course stored

### 2. Fixed LLM Command Result → Event Conversion

**Problem:** LLM commands executed but results weren't converted to events.

**Solution:** Added conversion logic based on `command.task`:

```python
elif isinstance(command, LLMCommand):
    if command_result.get('status') == 'success' and 'content' in command_result:
        task = command.task or ''
        
        if task == 'generate_course_parts':
            event = PartsGeneratedEvent(parts_text=content)
            current_result = reduce_course_event(current_state, event)
            current_state = current_result.new_state
            
        elif task == 'generate_part_sections':
            part_index = command.prompt_variables.get('part_index', 0)
            event = PartSectionsGeneratedEvent(
                sections_text=content,
                part_index=part_index
            )
            current_result = reduce_course_event(current_state, event)
            current_state = current_result.new_state
            
        elif task == 'review_outline':
            event = OutlineReviewEvent(reviewed_outline_text=content)
            current_result = reduce_course_event(current_state, event)
            current_state = current_result.new_state
```

### 3. Added CreateCourseCommand Handling

**Problem:** Course creation command results weren't converted to events.

**Solution:** Added conversion to `CourseStoredEvent`:

```python
elif isinstance(command, CreateCourseCommand):
    if command_result.get('status') == 'success':
        course_id = command_result.get('course_id', '')
        event = CourseStoredEvent(course_id=course_id)
        current_result = reduce_course_event(current_state, event)
        current_state = current_result.new_state
```

### 4. Added Error Handling

**Enhancement:** LLM and course creation failures now create `CourseEventError` events instead of breaking the pipeline silently.

## Complete Event Flow (Now Working)

```
1. CourseRequestedEvent ✅
   → EmbedCommand ✅
   
2. EmbeddingGeneratedEvent ✅
   → SearchBookSummariesCommand ✅
   
3. BookSummariesFoundEvent ✅
   → LLMCommand(task="generate_course_parts") ✅
   
4. PartsGeneratedEvent ✅ FIXED
   → LLMCommand(task="generate_part_sections", part_index=0) ✅
   
5. PartSectionsGeneratedEvent ✅ FIXED
   → LLMCommand(task="generate_part_sections", part_index=1) ✅
   
6. PartSectionsGeneratedEvent ✅ FIXED
   → ... (continue for all parts)
   
7. AllPartsCompleteEvent ✅ (generated by logic)
   → LLMCommand(task="review_outline") ✅
   
8. OutlineReviewEvent ✅ FIXED
   → CreateCourseCommand ✅
   
9. CourseStoredEvent ✅ FIXED
   → Pipeline complete ✅
```

## Testing

### What to Test

1. **End-to-end flow:**
   ```bash
   aws lambda invoke \
     --function-name docprof-dev-course-generator \
     --payload '{"body": "{\"query\": \"Learn DCF valuation\", \"hours\": 2.0}"}' \
     --cli-binary-format raw-in-base64-out /tmp/course-test.json
   ```

2. **Verify logs show:**
   - Embedding generation
   - Book search with results
   - Parts generation (Phase 1)
   - Sections generation for each part (Phase 2-N)
   - Outline review (Phase N+1)
   - Course storage

3. **Check for:**
   - No "unknown task" warnings
   - Proper event conversions logged
   - Pipeline completes successfully
   - Course outline in response

## Next Steps

1. **Test end-to-end** - Verify complete pipeline works
2. **Compare with MAExpert** - Ensure same output format
3. **Verify prompts** - Check prompts match MAExpert exactly
4. **Test edge cases** - Empty books, errors, etc.

## Files Modified

- `src/lambda/course_generator/handler.py` - Fixed event conversion logic
