# Book ID Consistency Fix

## Problem

Chunks were being created with different `book_id` values than the book record in the `books` table, causing data fragmentation.

## Root Cause

**MAExpert's `run_ingestion_pipeline` determines `book_id` internally**:
1. Handler extracts `book_id` from S3 metadata (e.g., `64A0CAB4...`)
2. Passes it to MAExpert pipeline
3. **But MAExpert calls `database.find_book()` which matches by metadata** (title/author/edition/isbn)
4. If match found → uses that `book_id` (could be different!)
5. If no match → creates new book with NEW `book_id` (generated by database)
6. **Chunks use whatever `book_id` MAExpert determines, NOT the S3 upload ID**

## What Happened

1. **First ingestion**: Created book `2be37d39...` (with "Unknown" title initially)
2. **Metadata updated**: Book `2be37d39...` updated with correct title/author
3. **Second ingestion**: MAExpert's `find_book()` didn't match (metadata mismatch?), created NEW book `29e7427e...`
4. **Result**: Chunks split between two books:
   - Book 1 (`2be37d39...`): 1,622 chunks, 110 figures, 39 chapters
   - Book 2 (`29e7427e...`): 1,547 chunks, 35 figures, 39 chapters

## Solution Applied

**Merged Book 2 into Book 1**:
- Moved all chunks from `29e7427e...` → `2be37d39...`
- Moved all figures from `29e7427e...` → `2be37d39...`
- Moved chapters (deleted duplicates with same chapter_number)
- Deleted Book 2 (`29e7427e...`)

**Result**: All chunks now reference the same `book_id` (`2be37d39...`)

## Prevention

**Issue**: Handler passes `book_id` to `patch_ingestion_flow_for_early_exit`, but MAExpert determines its own `book_id` internally.

**Options for future**:
1. **Option A**: Ensure `find_book()` matches correctly (fix metadata matching)
2. **Option B**: Force MAExpert to use provided `book_id` (modify `run_ingestion_pipeline`)
3. **Option C**: Use `book_id` from S3 metadata directly, bypass `find_book()` for new uploads

**Recommendation**: Option C - For new uploads, use the S3 `book-id` directly if provided, only use `find_book()` for resuming existing books.

## Current Status

✅ **Fixed**: All chunks now reference book `2be37d39-7255-4f67-a62b-5c010893a583`  
✅ **Metadata**: Book has correct title/author/edition  
✅ **Consistency**: All chunks, figures, chapters use same `book_id`

---

**Date**: December 11, 2025  
**Status**: Resolved

